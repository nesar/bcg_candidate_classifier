# BCG Deployment Package

A pip-installable Python package for deploying trained BCG (Brightest Cluster Galaxy) classification models on new astronomical cluster images.

## Features

- **Easy Model Deployment**: Load trained models with a single function call
- **Batch Processing**: Process entire directories of cluster images
- **GPU Support**: Automatic GPU detection and usage (with CPU fallback)
- **Rich Outputs**: Generate CSV results and annotated images with ranked candidates
- **Uncertainty Quantification**: Probabilistic predictions with calibrated uncertainties

## Requirements

### Input Requirements

#### 1. Cluster Images
- **Format**: `.tif` files
- **Size**: 3.8 arcmin × 3.8 arcmin (typically 400×400 pixels)
- **Type**: RGB or grayscale
- **Organization**: All images in a single directory

#### 2. BCG Candidates CSV
The candidates CSV must follow the DESprior format with these columns:
- `filename`: Image filename (e.g., `cluster_001.tif`)
- `x`: X-coordinate of candidate (pixels)
- `y`: Y-coordinate of candidate (pixels)
- `delta_mstar`: Magnitude difference from cluster characteristic magnitude
- `starflag`: Star/galaxy classification flag

Example:
```csv
filename,x,y,delta_mstar,starflag
cluster_001.tif,200,150,-2.5,0
cluster_001.tif,180,200,-1.8,0
cluster_002.tif,195,195,-3.1,0
```

#### 3. Trained Models
The model directory should contain:
- `best_probabilistic_classifier.pth` (or `.pt`) - Trained PyTorch model
- `best_probabilistic_classifier_scaler.pkl` - Feature scaler
- `best_probabilistic_classifier_color_extractor.pkl` - Color feature extractor (optional)

These files are generated by the training pipeline (`enhanced_full_run.py`).

## Installation

### Option 1: Install from source (recommended)

```bash
cd bcg_deployment
pip install -e .
```

### Option 2: Install dependencies only

```bash
cd bcg_deployment
pip install -r requirements.txt
```

## Quick Demo

**Try it immediately with included demo data!**

The package includes a `demo/` folder with:
- Pre-trained models (Oct 10, 2025 experiment)
- 5 test images from 3.8 arcmin BCG dataset
- Corresponding candidate catalog
- Complete documentation

Run the demo:

```bash
# From the bcg_deployment directory
python scripts/run_inference.py \
  --model_dir demo/models \
  --image_dir demo/images \
  --candidates_csv demo/demo_candidates.csv \
  --output_dir demo/results
```

Expected output: Perfect BCG predictions (rank 1) for all 5 images in <1 minute.

See `demo/README.md` for detailed information and expected results.

## Usage

### Command-Line Interface

The easiest way to run inference:

```bash
python scripts/run_inference.py \
  --model_dir /path/to/trained_models/experiment_dir \
  --image_dir /path/to/cluster_images \
  --candidates_csv /path/to/desprior_candidates.csv \
  --output_dir /path/to/output
```

#### CLI Options

- `--model_dir` (required): Directory containing trained model files
- `--image_dir` (required): Directory containing cluster images
- `--candidates_csv` (required): Path to BCG candidates CSV file
- `--output_dir` (required): Directory to save results
- `--model_name`: Name of model files without extension (default: `best_probabilistic_classifier`)
- `--detection_threshold`: Probability threshold for BCG detection, 0.0-1.0 (default: 0.5)
- `--no-gpu`: Disable GPU usage (use CPU only)
- `--no-images`: Skip saving annotated images (only save CSV results)

#### Example with Custom Threshold

```bash
python scripts/run_inference.py \
  --model_dir ./trained_models/my_experiment \
  --image_dir ./cluster_images \
  --candidates_csv ./desprior_candidates_3p8arcmin.csv \
  --output_dir ./inference_results \
  --detection_threshold 0.7
```

#### Example for CPU-Only Systems

```bash
python scripts/run_inference.py \
  --model_dir ./trained_models/my_experiment \
  --image_dir ./cluster_images \
  --candidates_csv ./desprior_candidates_3p8arcmin.csv \
  --output_dir ./inference_results \
  --no-gpu
```

### Python API

You can also use the package programmatically:

```python
from bcg_deploy import BCGInference

# Initialize inference engine
inference = BCGInference(
    model_dir="/path/to/trained_models/experiment_dir",
    image_dir="/path/to/cluster_images",
    candidates_csv="/path/to/desprior_candidates.csv",
    output_dir="/path/to/output",
    use_gpu=True
)

# Run inference
results = inference.run_inference(
    model_name='best_probabilistic_classifier',
    detection_threshold=0.5,
    save_images=True
)

# Access results
for result in results['results']:
    print(f"{result['filename']}: BCG at ({result['pred_x']:.1f}, {result['pred_y']:.1f})")
    print(f"  Probability: {result['probability']:.3f} ± {result['uncertainty']:.3f}")
    print(f"  Rank: {result['rank']}, Candidates: {result['n_candidates']}")
```

### Using Configuration Dictionary

```python
from bcg_deploy.inference import run_inference_from_config

config = {
    'model_dir': '/path/to/models',
    'image_dir': '/path/to/images',
    'candidates_csv': '/path/to/candidates.csv',
    'output_dir': '/path/to/output',
    'model_name': 'best_probabilistic_classifier',
    'detection_threshold': 0.5,
    'use_gpu': True,
    'save_images': True
}

results = run_inference_from_config(config)
```

## Output Files

The package generates the following outputs in the specified output directory:

### 1. `evaluation_results.csv`
Summary results for each image:
- `filename`: Image filename
- `pred_x`, `pred_y`: Predicted BCG coordinates
- `rank`: Rank of best candidate (1 = highest probability)
- `max_probability`: BCG probability (0-1)
- `max_uncertainty`: Uncertainty estimate
- `n_candidates`: Total number of candidates evaluated
- `n_detections`: Number of candidates above detection threshold

### 2. `probability_analysis.csv`
Detailed per-candidate analysis:
- `filename`: Image filename
- `candidate_idx`: Candidate index
- `x`, `y`: Candidate coordinates
- `probability`: BCG probability
- `uncertainty`: Uncertainty estimate
- `is_best_candidate`: Whether this is the top-ranked candidate

### 3. `annotated_images/` (directory)
Annotated PNG images showing:
- Original cluster image
- Top 10 ranked candidates marked with circles
- Rank and probability labels for each candidate
- Color-coding: Red (rank 1), Orange (ranks 2-3), Yellow (ranks 4-10)

## Model Compatibility

This deployment package is designed for models trained with the `enhanced_full_run.py` pipeline using the following default settings:
- **Model Type**: Probabilistic classifier with uncertainty quantification
- **Color Features**: Enabled (RGB-based red-sequence detection)
- **Candidate Source**: DESprior catalog candidates
- **Additional Features**: Redshift and delta_mstar_z (if available)

The package expects models from the `bcg_candidate_classifier` repository and requires the parent repository to be present for importing model architectures and utilities.

## GPU Support

The package automatically detects and uses GPUs when available:
- **CUDA GPUs**: Automatically used if PyTorch detects CUDA
- **CPU Fallback**: Automatically switches to CPU if no GPU available
- **Manual Control**: Use `--no-gpu` flag or `use_gpu=False` to force CPU mode

## Troubleshooting

### Import Errors
If you encounter import errors like `ModuleNotFoundError: No module named 'ml_models'`:
- Ensure the `bcg_deployment` folder is inside the `bcg_candidate_classifier` directory
- The package automatically adds the parent directory to Python path

### CUDA Out of Memory
If you run out of GPU memory:
- Use `--no-gpu` to run on CPU
- Process fewer images at once
- Use a system with more GPU memory

### Missing Model Files
Ensure your model directory contains all three files:
- `best_probabilistic_classifier.pth`
- `best_probabilistic_classifier_scaler.pkl`
- `best_probabilistic_classifier_color_extractor.pkl`

### Image Size Warnings
If you see size warnings:
- Ensure images are 3.8 arcmin × 3.8 arcmin (typically 400×400 pixels)
- The model may still work but performance could be affected

## Example Workflow

Here's a complete workflow from training to deployment:

```bash
# 1. Train model (in parent directory)
cd bcg_candidate_classifier
python enhanced_full_run.py
# ... follow prompts, select 3.8 arcmin dataset, enable UQ and color features

# 2. Note the output directory, e.g.:
# trained_models/candidate_classifier_color_uq_run_20250110_120000/

# 3. Run inference on new data
cd bcg_deployment
python scripts/run_inference.py \
  --model_dir ../trained_models/candidate_classifier_color_uq_run_20250110_120000 \
  --image_dir /path/to/new/cluster/images \
  --candidates_csv /path/to/new/candidates.csv \
  --output_dir ./inference_results_new_data

# 4. View results
ls inference_results_new_data/
# evaluation_results.csv
# probability_analysis.csv
# annotated_images/
```

## Citation

If you use this package in your research, please cite:

```bibtex
@software{bcg_deploy,
  title={BCG Deployment Package},
  author={BCG Classifier Team},
  year={2025},
  url={https://github.com/your-repo/bcg_candidate_classifier}
}
```

## License

[Add your license here]

## Contact

For questions or issues, please open an issue on the GitHub repository.
